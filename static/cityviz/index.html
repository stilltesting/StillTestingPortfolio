
<!DOCTYPE html>
<html>
<head>
	<title>CITYVIZ</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" href="./img/favicon.png">   

	<link rel="stylesheet" href="sources/style.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="sources/Leaflet/leaflet.ie.css" /><![endif]-->
	<script   src="https://code.jquery.com/jquery-3.3.1.min.js"   integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="   crossorigin="anonymous"></script>
	 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
	 <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
	<script src="./sources/geocoding/leaflet.geocoding.js"></script>
	
	<script type="text/javascript">
				$(document).ready(function(){
					var viewportHeight = $(window).height();
					$('#map, #description, #showDescriptionButton').css("height", viewportHeight);
				});
				
				$(window).resize(function(){
					var viewportHeight = $(window).height();
					$('#map, #description, #showDescriptionButton').css("height", viewportHeight);
				});
	</script>
</head>
<body>
	<div id="description">
		<div class="content">
			<h1>CITYVIZ</h1>
			<div class="logo"></div>
			
			<input id="geocodeinput" type="text" placeholder="Type city name">
			<button id="geocodebutton" onclick="geocode()">VISUALIZE!</button>
			

			
			<p>
				Have you ever wondered how would a city look, if you visualized it's venues by their usage and popularity? Kind of a urbanist study so to speak. Well, that's exactly what this visualization does... not show. 
			</p>
			<p>
				What it does show is all-but-logical selection of venues from five categories (50 venues each, Foursquare limitation, don't ask) scraped from Foursquare API. The venues are then placed into a map with a scale coresponding to their "popularity" (homebrewed equation: popular are those places, which have fairly large number of visitors, who tend to return there). 
			</p>
			
			<h2>LEGEND</h2>
			<ul>
				<li><span class="legend outdoors"></span>Outdoors &amp; Recreation</li>
				<li><span class="legend food"></span>Food</li>
				<li><span class="legend art"></span>Arts &amp; Entertainment</li>
				<li><span class="legend university"></span>College &amp; University</li>
				<li><span class="legend nightlife"></span>Nightlife</li>
			</ul>
			
		</div>
	</div>
	<div id="showDescriptionButton" onclick="showSidebar()"></div>
	
	<div id="map" class="setHeight"></div>
	
	<script type="text/javascript">
		var config = {
    		foursquareApiKey: '4K44GZ2WHAJKPZH2VUJKHWWAPUV10F0N4H0LLONCTBZEA4X3',
    		foursquareAuthUrl: 'https://foursquare.com/oauth2/authorize',
    		foursquareUrl: 'https://api.foursquare.com/',
  		};
		
		var lat = 16;
		var lng = -45;
		
		var geolocated = false;
		
		/* Create map. */
		var map = new L.Map('map').setView(new L.LatLng(lat, lng), 3);
		    
		L.tileLayer('https://{s}.tiles.mapbox.com/v3/sane87.map-1pyi0b7q/{z}/{x}/{y}.png').addTo(map);
		
		var outdoorLayerGroup = new L.LayerGroup();
		var foodLayerGroup = new L.LayerGroup();
		var uniLayerGroup = new L.LayerGroup();
		var cultureLayerGroup = new L.LayerGroup();
		var nightlifeLayerGroup = new L.LayerGroup();
					
		var geocoding = new L.Geocoding();
    	geocoding.setOptions({providers:'google'})
    	map.addControl(geocoding);
		
		if (location.hash.length > 3) {
			geolocated = true;
			place = location.hash.substring(location.hash.indexOf("loc=")+4,location.hash.length);
			geocoding.geocode(place);
		};
		
		$('#geocodeinput').on('keydown', function(e) {
       		if (e.keyCode == 13 ) {
        		e.preventDefault();
        		geocode();
        	}
      	});

		function geocode() {
			geolocated = true;
			
			geocoding.geocode($("#geocodeinput").val());
			location.hash = "loc=" + $("#geocodeinput").val();
		};
		
		map.on('moveend', function(e) {
			if (geolocated) {
				lat = map.getCenter().lat;
				lng = map.getCenter().lng;
			
				foursquareQuery();
				geolocated = false;
			}
		});

		function foursquareQuery() {
			//cleanUp();
						
		 	//OUTDOORS
			$.getJSON(config.foursquareUrl + 'v2/venues/search?ll=' + lat + ',' + lng + '&radius=15000' + '&limit=50' + '&intent=browse' + '&categoryId=4d4b7105d754a06377d81259' + '&client_id=' + config.foursquareApiKey + '&client_secret=' + 'OANCMDJEJDMQJYVMFGOBNX4VXBCZLMYFZAUO0KKVBP2QGWLB' + '&v=20130630', {}, function(data) {				
			    venues = data['response']['venues'];
			    /* Place marker for each venue. */
			    for (var i = 0; i < venues.length; i++) {
			      	/* Get marker's location */
			      	var latLng = new L.LatLng(
			        	venues[i]['location']['lat'],
			        	venues[i]['location']['lng']
			      	);
			      	
			      	var totalCheckins = parseFloat(venues[i]['stats']['checkinsCount']);
			      	var users = parseFloat(venues[i]['stats']['usersCount']);
			      	
			      	var radius = ((totalCheckins - users) / totalCheckins) * (users / (users+300) * 100);
			      	
			      	var link = venues[i]['canonicalUrl'];
			      	
			      	if (radius < 10) radius=10;
			      	/* Build icon for each icon */
			      	var marker = new L.CircleMarker(latLng, {fillColor: '#85CC2F', fillOpacity: 0.3, stroke: false})
			        .bindPopup('<div class="colorBar outdoors"></div><h3><a href=' + link + ' target="_blank">'  + venues[i]['name'] + '</a></h3>' + 'Total check-ins: ' + totalCheckins + '<br />Users count: ' + users, { closeButton: false })
			        .on('click', function(e) { this.openPopup(); });
			    	
			    	marker.setRadius(radius);
			    	outdoorLayerGroup.addLayer(marker);
				}
			});
			
			//FOOD
			$.getJSON(config.foursquareUrl + 'v2/venues/search?ll=' + lat + ',' + lng + '&radius=15000' + '&limit=100' + '&intent=browse' + '&categoryId=4d4b7105d754a06374d81259' + '&client_id=' + config.foursquareApiKey + '&client_secret=' + 'OANCMDJEJDMQJYVMFGOBNX4VXBCZLMYFZAUO0KKVBP2QGWLB' + '&v=20130630', {}, function(data) {
			    venues = data['response']['venues'];
			    /* Place marker for each venue. */
			    for (var i = 0; i < venues.length; i++) {
			      	/* Get marker's location */
			      	var latLng = new L.LatLng(
			        	venues[i]['location']['lat'],
			        	venues[i]['location']['lng']
			      	);
			      	var totalCheckins = parseFloat(venues[i]['stats']['checkinsCount']);
			      	var users = parseFloat(venues[i]['stats']['usersCount']);
			      	
			      	var radius = ((totalCheckins - users) / totalCheckins) * (users / (users+300) * 100);
			      	
			      	if (radius < 10) radius=10;
			      	
					var link = venues[i]['canonicalUrl'];
			      	/* Build icon for each icon */
			      	
			      	var marker = new L.CircleMarker(latLng, {fillColor: '#FD7400', fillOpacity: 0.3, stroke: false})
			        .bindPopup('<div class="colorBar food"></div><h3><a href=' + link + ' target="_blank">'  + venues[i]['name'] + '</a></h3>' + 'Total check-ins: ' + totalCheckins + '<br />Users count: ' + users, { closeButton: false })
			        .on('click', function(e) { this.openPopup(); });
			    	
			    	marker.setRadius(radius);
			    	foodLayerGroup.addLayer(marker);
				}
			});
			
			//UNIVERSITY
			$.getJSON(config.foursquareUrl + 'v2/venues/search?ll=' + lat + ',' + lng + '&radius=15000' + '&limit=100' + '&intent=browse' + '&categoryId=4d4b7105d754a06372d81259' + '&client_id=' + config.foursquareApiKey + '&client_secret=' + 'OANCMDJEJDMQJYVMFGOBNX4VXBCZLMYFZAUO0KKVBP2QGWLB' + '&v=20130630', {}, function(data) {
			    venues = data['response']['venues'];
			    /* Place marker for each venue. */
			    for (var i = 0; i < venues.length; i++) {
			      	/* Get marker's location */
			      	var latLng = new L.LatLng(
			        	venues[i]['location']['lat'],
			        	venues[i]['location']['lng']
			      	);
			      	var totalCheckins = parseFloat(venues[i]['stats']['checkinsCount']);
			      	var users = parseFloat(venues[i]['stats']['usersCount']);
			      	
			      	var radius = ((totalCheckins - users) / totalCheckins) * (users / (users+300) * 100);
			      	
			      	var link = venues[i]['canonicalUrl'];
			      	
			      	if (radius < 10) radius=10;
			      	/* Build icon for each icon */
			      	var marker = new L.CircleMarker(latLng, {fillColor: '#1F8A70', fillOpacity: 0.3, stroke: false})
			        .bindPopup('<div class="colorBar university"></div><h3><a href=' + link + ' target="_blank">'  + venues[i]['name'] + '</a></h3>' + 'Total check-ins: ' + totalCheckins + '<br />Users count: ' + users, { closeButton: false })
			        .on('click', function(e) { this.openPopup(); });
			        
			    	marker.setRadius(radius);
			    	uniLayerGroup.addLayer(marker);
				}
			});
			
			//CULTURE
			$.getJSON(config.foursquareUrl + 'v2/venues/search?ll=' + lat + ',' + lng + '&radius=15000' + '&limit=100' + '&intent=browse' + '&categoryId=4bf58dd8d48988d1e2931735,4bf58dd8d48988d17f941735,4bf58dd8d48988d181941735,4bf58dd8d48988d1e5931735,4bf58dd8d48988d1f2931735' + '&client_id=' + config.foursquareApiKey + '&client_secret=' + 'OANCMDJEJDMQJYVMFGOBNX4VXBCZLMYFZAUO0KKVBP2QGWLB' + '&v=20130630', {}, function(data) {
			    venues = data['response']['venues'];
			    /* Place marker for each venue. */
			    for (var i = 0; i < venues.length; i++) {
			      	/* Get marker's location */
			      	var latLng = new L.LatLng(
			        	venues[i]['location']['lat'],
			        	venues[i]['location']['lng']
			      	);
			      	var totalCheckins = parseFloat(venues[i]['stats']['checkinsCount']);
			      	var users = parseFloat(venues[i]['stats']['usersCount']);
			      	
			      	var radius = ((totalCheckins - users) / totalCheckins) * (users / (users+300) * 100);
			      	
			      	var link = venues[i]['canonicalUrl'];
			      	
			      	if (radius < 10) radius=10;
			      	/* Build icon for each icon */
			      	var marker = new L.CircleMarker(latLng, {fillColor: '#AB124E', fillOpacity: 0.3, stroke: false})
			        .bindPopup('<div class="colorBar art"></div><h3><a href=' + link + ' target="_blank">'  + venues[i]['name'] + '</a></h3>' + 'Total check-ins: ' + totalCheckins + '<br />Users count: ' + users, { closeButton: false })
			        .on('click', function(e) { this.openPopup(); });
			    	
			    	marker.setRadius(radius);
			    	cultureLayerGroup.addLayer(marker);
				}
			});
			
			//NIGHTLIFE
			$.getJSON(config.foursquareUrl + 'v2/venues/search?ll=' + lat + ',' + lng + '&radius=15000' + '&limit=100' + '&categoryId=4d4b7105d754a06376d81259' + '&client_id=' + config.foursquareApiKey + '&client_secret=' + 'OANCMDJEJDMQJYVMFGOBNX4VXBCZLMYFZAUO0KKVBP2QGWLB' + '&v=20130630', {}, function(data) {
			    venues = data['response']['venues'];
			    /* Place marker for each venue. */
			    for (var i = 0; i < venues.length; i++) {
			      	/* Get marker's location */
			      	var latLng = new L.LatLng(
			        	venues[i]['location']['lat'],
			        	venues[i]['location']['lng']
			      	);
			      	
			      	var totalCheckins = parseFloat(venues[i]['stats']['checkinsCount']);
			      	var users = parseFloat(venues[i]['stats']['usersCount']);
			      	
			      	var radius = ((totalCheckins - users) / totalCheckins) * (users / (users+300) * 100);
			      	
			      	var link = venues[i]['canonicalUrl'];
			      	
			      	if (radius < 10) radius=10;
			      	/* Build icon for each icon */
			      	var marker = new L.CircleMarker(latLng, {fillColor: '#FFE11A', fillOpacity: 0.3, stroke: false})
			        .bindPopup('<div class="colorBar nightlife"></div><h3><a href=' + link + ' target="_blank">'  + venues[i]['name'] + '</a></h3>' + 'Total check-ins: ' + totalCheckins + '<br />Users count: ' + users, { closeButton: false })
			        .on('click', function(e) { this.openPopup(); })
			    	
			    	marker.setRadius(radius);
			    	nightlifeLayerGroup.addLayer(marker);
				}
			});
			
			
			hideSidebar();
			
			outdoorLayerGroup.addTo(map);
			foodLayerGroup.addTo(map);
			uniLayerGroup.addTo(map);
			cultureLayerGroup.addTo(map);
			nightlifeLayerGroup.addTo(map);
			
		};
		
		function cleanUp() {
			outdoorLayerGroup.clearLayers();
			foodLayerGroup.clearLayers();
			uniLayerGroup.clearLayers();
			cultureLayerGroup.clearLayers();
			nightlifeLayerGroup.clearLayers();
		};
		
		function hideSidebar() {
			$('#description').hide(300);
			$('.leaflet-left ').css('left','50px');
			$('#showDescriptionButton').show();
		};
		
		function showSidebar() {
			$('#description').show(300);
			$('.leaflet-left ').css('left','300px');
			$('#showDescriptionButton').hide();
		};
	</script>
</body>
</html>
